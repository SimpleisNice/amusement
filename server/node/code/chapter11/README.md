# 11장 OAuth 를 사용한 구글 로그인 인증하기

## 11.1 OAuth 소개

Open Authorization 의 약자로 2006년 구글과 트위터가 만든 개발형 인가의 표준

OAuth2를 본격적으로 알아보기 전에 여러 용어를 알아보자

- 인증
  - 리소스에 접근 자격이 있는지 검증하는 과정
  - OAuth 에서 리소스는 보호된 정보를 의미
- 인가
  - 자원에 접근할 권한을 부여하는 과정
  - 인가가 완료되면 리소스의 접근 원한 정보가 있는 액세스 토큰을 클라이언트에게 보내줌
- 액세스 토큰
  - 리소스 서버에서 리소스 소유자의 보호된 정보를 획득할 때 사용하는 만료 기간이 있는 토큰
- 리프레시 토큰
  - 액세스 토큰이 만료되었을 때 갱신하는 용도로 사용하는 토큰
  - 액세스 토큰보다 만료 기간을 길게 가지고감
- 리소스 소유자
  - 리소스는 사용자의 보호된 정보를 말하며 이런 정보에 접근하도록 자격을 부여하는 사람을 말함
  - OAuth 에서는 사용자가 리소스 소유자 라고 생각하면 됨
- 클라이언트
  - 리소스를 사용하려고 접근을 요청하는 애플리케이션을 의미
- 리소스 서버
  - 사용자의 보호된 자원을 가지고 있는 서버
- 인가 서버
  - 인증/인가를 수행하는 서버로 클라이언트의 접근 자격을 확인하고 액세스 토큰을 발급해 권한을 부여함

### 11.1.1 OAuth 프로토콜의 흐름

1. 클라이언트가 리소스 소유자에게 인가 요청
2. 리소스 소유자는 클라이언트에게 인가 승인 요청
3. 클라이언트는 2에서 받은 정보로 인가 서버에게 액세스 토큰 요청
4. 인가 서버는 액세스 클라이언트에게 액세스 토큰 발급
5. 클라이언트는 리소스 서버에게 액세스 토큰으로 보호된 자원 요청
6. 리로스 서버는 클라이언트에게 보호된 자원의 정보를 내려줌

### 11.1.2 액세스 토큰을 재발행하는 흐름

액세스 토큰 만료 시 리프레시 토큰을 재발행하는 흐름을 알아보자

1. 클라이언트는 인가 서버에게 인가 승인 요청
2. 인가 서버는 클라이언트에게 액세스 토큰과 리프레시 토큰을 발급
3. 클라이언트는 리소스 서버에게 액세스 토큰 전달
4. 리소스 서버는 클라이언트에게 보호된 리소스를 내려줌
5. 클라이언트는 리소스 서버에게 만료된 액세스 토큰 전달
6. 리소스 서버는 클라이언트에게 유효하지 않은 토큰 에러 전달
7. 클라이언트는 인가 서버에게 리프레시 토큰 전달
8. 인가 서버는 클라이언트에게 새로운 액세스 토큰(옵션: 리프레시 토큰) 발급

## 11.2 구글 OAuth 를 사용하기 위한 준비

### 11.2.1 구글 클라우드에서 프로젝트 생성하기

https://console.cloud.google.com/

### 11.2.2 OAuth 동의 화면을 만들기

OAuth 동의 화면서 "외부"를 선택하고 생성

### 11.2.3 OAuth 클라이언트의 ID 와 비밀번호 만들기

## 11.3 구글 OAuth 구현 순서

1. 클라이언트는 구글OAuth에게 사용자 인증 정보를 요청
2. 구글 OAuth는 구글 스트래티지에게 액세스 토큰을 요청

구글 OAuth로 가입한 유저는 패스워드가 없으므로 구글 OAuth로 가입한 유저라는 것을 알 수 있도록 구글 OAuth의 식별자인 providerI를 같이 저장하는 것이 좋음

GoogleStrategy의 validate() 메서드에서는 인증 시 유저 데이터가 있으면 가져오고 없으면 저장하는 로직이 필요함

## 11.4 NestJS 환경 설정 파일 추가

01 프로젝트 생성 및 패키지 설치

```
nest new {project name}

cd {project name}

npm i

npm i @nestjs/config
```

02 구글 OAuth용 환경 설정 파일 만들고 값을 설정

- 해당 내용은 유출되면 보안에 문제가 생길 수 있으므로 저장소에 올리지 않도록 하는것이 좋다.

```env
# .env
GOOGLE_CLIENT_ID={구글 OAuth 클라이언트 ID}
GOOGLE_CLIENT_SECRET={구글 OAuth 클라이언트 시크릿}
```

## 11.5 구글 OAuth 스트래티지 만들기

```
npm i passport-google-oauth20
npm i -D @types/passport-google-oauth20
```

## 11.6 GoogleAuthGuard 만들기

## 11.7 컨트롤러에 핸들러 메서드 추가하기

## 11.8 User 엔티티 파일 수정하기

## 11.9 UserService에 구글 유저 검색 및 저장 메서드 추가하기

## 11.10 GoogleStrategy에 구글 유저 정하는 메서드 적용하기

## 11.11 GoogleAuthGuard에 세션을 사용하도록 변경하기

## 11.12 테스트 하기
